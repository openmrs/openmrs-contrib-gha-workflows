name: Build OpenMRS Maven Module

on:
  workflow_call:
    inputs:
      java_versions:
        description: 'Java versions to build against (e.g. [8, 11, 17])'
        type: string
      main_java_version:
        description: 'Java version to use for publishing artifacts (must be included in java_versions)'
        type: string
      java_distribution:
        description: 'Java distribution'
        type: string
        default: 'temurin'
      maven_args:
        description: 'Maven Arguments'
        type: string
        default: 'clean install'
      run_owasp_check:
        description: 'Whether to run the OWASP Dependency Check'
        type: boolean
        default: true
      fail_on_cvss:
        description: 'CVSS score threshold to fail the build (0-10)'
        type: string
        default: '6.2'
      suppression_file:
        description: 'Path to the dependency-check suppressions XML file'
        type: string
        default: 'dependency-check-suppressions.xml'
      owasp_additional_args:
        description: 'Additional arguments to pass to OWASP Dependency-Check'
        type: string
        default: '--enableRetired'
      upload_coverage:
        description: 'Whether to upload coverage reports to Codecov'
        type: boolean
        default: true
    secrets:
      NVD_API_KEY:
        description: 'NVD API key for faster vulnerability database updates'
        required: false

jobs:
  build:
    name: Build with Java ${{ matrix.java }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        java: ${{ fromJSON(inputs.java_versions) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Java ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: ${{ inputs.java_distribution }}
          cache: maven

      - name: Build with Maven
        run: mvn --batch-mode ${{ inputs.maven_args }}

      - name: Upload coverage to Codecov
        if: ${{ inputs.upload_coverage && matrix.java == fromJSON(inputs.main_java_version) }}
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          use_oidc: true

      - name: Get OMOD file Name
        id: get_omod_name
        run: echo "final_name=$(mvn help:evaluate -Dexpression=project.build.finalName -q -DforceStdout -pl omod)" >> $GITHUB_OUTPUT

      - name: Generate checksums for OMOD
        if: matrix.java == fromJSON(inputs.main_java_version)
        run: |
          
          set -euo pipefail
          
          FILE="omod/target/${{ steps.get_omod_name.outputs.final_name }}.omod"
          
          sha1sum   "$FILE" | awk '{print $1}' > "$FILE.sha1"
          sha256sum "$FILE" | awk '{print $1}' > "$FILE.sha256"

      - name: Upload OMOD + checksums
        if: matrix.java == fromJSON(inputs.main_java_version)
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.get_omod_name.outputs.final_name }}
          path: |
            omod/target/${{ steps.get_omod_name.outputs.final_name }}.omod
            omod/target/${{ steps.get_omod_name.outputs.final_name }}.omod.sha1
            omod/target/${{ steps.get_omod_name.outputs.final_name }}.omod.sha256
          if-no-files-found: error

  owasp-dependency-check:
    if: ${{ inputs.run_owasp_check }}
    uses: openmrs/openmrs-contrib-gha-workflows/.github/workflows/owasp-dependency-check.yml@main
    with:
      java_version: ${{ inputs.main_java_version }}
      java_distribution: ${{ inputs.java_distribution }}
      fail_on_cvss: ${{ inputs.fail_on_cvss }}
      suppression_file: ${{ inputs.suppression_file }}
      additional_args: ${{ inputs.owasp_additional_args }}
    secrets:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

